globals:

- id: zone_control_delay_time
  type: int
  initial_value: "0"
- id: zone_control_score_red_ms
  type: int
  initial_value: "0"
- id: zone_control_score_yellow_ms
  type: int
  initial_value: "0"
- id: zone_control_team_change_perc
  type: float
  initial_value: "0"

- id: zone_control_current_team
  type: std::string
  initial_value: "" # TEAM_RED | TEAM_YELLOW | NONE

script:
  - id: gm_zone_control_display_update
    parameters:
      disp: lcd_base::LCDDisplay&
    then:
      - lambda: |-
          if (!id(settings_initiated)) {
            // Settings display and selection
            if (id(current_menu) == 0) {
              disp.printf(0, 0, "> Delay min: %d", id(zone_control_delay_time));
              disp.printf(0, 1, "  START");
            } else if (id(current_menu) == 1) {
              disp.printf(0, 0, "  Delay min: %d", id(zone_control_delay_time));
              disp.printf(0, 1, "> START");
            } 
          } else {
              // Gameplay display
              if (id(prep_for_game_timer).state != 0) {
                // Displays time before game actuals starts
                disp.printf(0, 0, " PREP FOR GAME");
                disp.printf(0, 1, "     %s", format_time_remaining(id(prep_for_game_timer).state).c_str());
              } else {
                // Game started
                if (id(gm_finished)) {
                  disp.printf(0, 0, "zone_control ENDED");
                }
                else {
                  //disp.printf(0, 0, "TIME LEFT: %s", format_time_remaining(id(game_zone_control_timer).state).c_str());
                }

                if (id(zone_control_team_change_perc) > 0) {
                  disp.printf(0, 1, "%.2f", id(zone_control_team_change_perc));
                } else {
                  disp.printf(0, 1, "Tr:%4d Ty:%4d", int(id(zone_control_score_red_ms) / 1000.0), int(id(zone_control_score_yellow_ms) / 1000.0));
                }
                
              }
          }

  - id: gm_zone_control_handle_key_pressed
    parameters:
      key: std::string
    then:
      - lambda: |-
          if (!id(settings_initiated)) {
            id(gm_zone_control_handle_key_pressed_menu).execute(key);
          } else {
            id(gm_zone_control_handle_key_pressed_game).execute(key);
          }
  - id: gm_zone_control_handle_key_pressed_game
    parameters:
      key: std::string
    then:
      - lambda: |-
          if (id(prep_for_game_timer).state != 0) {
              return;
          } else {
  
          }
  - id: gm_zone_control_handle_key_pressed_menu
    parameters:
        key: std::string
    then:
      - lambda: |-
          int next_menu = id(current_menu);

          if (key == "A") {
            // Move menu up
            next_menu = next_menu - 1;
            if (next_menu < 0) {
              next_menu = 1;
            }
            id(current_menu) = next_menu;
          } else if(key == "B") {
            // Move menu down
            next_menu = next_menu + 1;
            if (next_menu > 1) {
              next_menu = 0;
            }
            id(current_menu) = next_menu;
          } else if(key == "C") {
            // Clear selection or start the game
            if (next_menu == 0) {
              id(zone_control_delay_time) = 0;
            } else if (next_menu == 1) {
              // Start the game
              id(zone_control_current_team) = "NONE";

              id(gm_start_game).execute(id(zone_control_delay_time));
              ESP_LOGI("GM_zone_control", "Starting the game");
            }
          }

          if (std::isdigit(key[0])) {
            // If digit is pressed check if anything needs to be done
            // If menu with number input is slected process the number

            if (next_menu == 0) {
              id(zone_control_delay_time) = append_digit(key, id(zone_control_delay_time));
            }
          }
  - id: gm_zone_control_actual_start
    then:
      - lambda: |-

  - id: gm_zone_control_clock
    then:
      - lambda: |-
          bool game_finished = id(gm_finished);


          if (!game_finished and id(prep_for_game_timer).state == 0) {
            int duration_pressed_ms = 0;
            std::string team_btn_pressed = "NONE";
            if (id(r_button_press_duration) > id(y_button_press_duration)) {
                duration_pressed_ms = id(r_button_press_duration);
                team_btn_pressed = "TEAM_RED";
              } else {
                duration_pressed_ms = id(y_button_press_duration);
                team_btn_pressed = "TEAM_YELLOW";
            }

            if (duration_pressed_ms > 0 and id(zone_control_current_team) != team_btn_pressed) {
              id(zone_control_team_change_perc) = duration_pressed_ms / 5000.0 * 100.0;
              if (duration_pressed_ms > 5000) {
                id(zone_control_current_team) = team_btn_pressed;
                id(zone_control_team_change_perc) = 100;
                id(reset_yellow_btn_timer).execute();
                id(reset_red_btn_timer).execute();
              }
            } else {
              id(zone_control_team_change_perc) = 0;

              int last_clock_ms = id(gm_clock_last_update_ms);
              int time_passed = millis() - last_clock_ms;

              if (id(zone_control_current_team) == "TEAM_RED") {
                id(zone_control_score_red_ms) = id(zone_control_score_red_ms) + time_passed;
              } else if (id(zone_control_current_team) == "TEAM_YELLOW") {
                id(zone_control_score_yellow_ms) = id(zone_control_score_yellow_ms) + time_passed;
              }
            }
          }

          
